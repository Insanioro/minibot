import asyncio
import logging
from datetime import datetime, timedelta
from typing import Dict, Set
import json
import os

from telegram import Update, ChatMemberUpdated, ChatMember, Chat
from telegram.ext import Application, ChatJoinRequestHandler, ChatMemberHandler, ContextTypes, CommandHandler
from telegram.constants import ChatAction, ParseMode, ChatType
from telegram.error import BadRequest, Forbidden, TimedOut, NetworkError, Conflict
import signal
import sys

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

class TelegramBot:
    def __init__(self, token: str):
        self.token = token
        self.pending_requests: Dict[str, Dict] = {}  # user_id -> {chat_id, request_time, user_data}
        self.approved_users: Set[str] = set()  # –º–Ω–æ–∂–µ—Å—Ç–≤–æ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        self.config = self.load_config()
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–Ω–∞–ª–∞–º/–≥—Ä—É–ø–ø–∞–º
        self.channel_stats = {}  # chat_id -> —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–∞–Ω–∞–ª–∞
        self.tracked_groups = set()  # –º–Ω–æ–∂–µ—Å—Ç–≤–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –≥—Ä—É–ø–ø
        
        # –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Å—É–º–º–∞ –ø–æ –≤—Å–µ–º –∫–∞–Ω–∞–ª–∞–º)
        self.global_stats = {
            'hourly_requests': 0,
            'hourly_left': 0,
            'daily_requests': 0,
            'daily_left': 0,
            'total_requests': 0,
            'total_approved': 0,
            'total_left': 0
        }
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        self.load_stats_from_file()
        
    def load_config(self) -> Dict:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ —Ñ–∞–π–ª–∞ config.json"""
        try:
            with open('config.json', 'r', encoding='utf-8') as f:
                return json.load(f)
        except FileNotFoundError:
            logger.warning("–§–∞–π–ª config.json –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")
            return {
                "auto_approve_delay": 10,  # 10 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
                "welcome_message": " –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à—É –≥—Ä—É–ø–ø—É! –î–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏/–∑–∞–∫–∞–∑–∞: @apple_anastasiya",
                "admin_notification": True
            }
    
    async def handle_chat_join_request(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É"""
        if not update.chat_join_request:
            return
            
        request = update.chat_join_request
        user_id = str(request.from_user.id)
        chat_id = str(request.chat.id)
        chat_type = request.chat.type
        
        chat_title = request.chat.title or f"–ß–∞—Ç {chat_id}"
        logger.info(f"–ü–æ–ª—É—á–µ–Ω–∞ –∑–∞—è–≤–∫–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {request.from_user.first_name} ({user_id}) –≤ —á–∞—Ç '{chat_title}' ({chat_id}, —Ç–∏–ø: {chat_type})")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —á–∞—Ç–∞
        if chat_type not in [ChatType.GROUP, ChatType.SUPERGROUP, ChatType.CHANNEL]:
            logger.warning(f"–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —á–∞—Ç–∞: {chat_type}")
            return
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
        self.get_or_create_channel_stats(chat_id, chat_title)
        self.update_channel_stats(chat_id, 'hourly_requests')
        self.update_channel_stats(chat_id, 'daily_requests')
        self.update_channel_stats(chat_id, 'total_requests')
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä—É–ø–ø—É –≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ
        self.tracked_groups.add(chat_id)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—è–≤–∫–µ
        self.pending_requests[user_id] = {
            'chat_id': chat_id,
            'request_time': datetime.now(),
            'user_data': {
                'id': request.from_user.id,
                'first_name': request.from_user.first_name,
                'last_name': request.from_user.last_name,
                'username': request.from_user.username
            }
        }
        
        # –ü–ª–∞–Ω–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç
        delay = self.config.get("auto_approve_delay", 600)
        
        if context.job_queue is not None:
            context.job_queue.run_once(
                self.auto_approve_request,
                delay,
                data={'user_id': user_id, 'chat_id': chat_id},
                name=f"approve_{user_id}_{chat_id}"
            )
            logger.info(f"–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {delay} —Å–µ–∫—É–Ω–¥")
        else:
            logger.error("JobQueue –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω! –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")
        
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)
        if self.config.get("admin_notification", True):
            await self.notify_admins(context, request)
    
    async def auto_approve_request(self, context: ContextTypes.DEFAULT_TYPE):
        """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–¥–æ–±—Ä—è–µ—Ç –∑–∞—è–≤–∫—É —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤—Ä–µ–º—è"""
        job_data = context.job.data
        user_id = job_data['user_id']
        chat_id = job_data['chat_id']
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞—è–≤–∫–∞ –≤—Å–µ –µ—â–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞
        if user_id not in self.pending_requests:
            logger.info(f"–ó–∞—è–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞")
            return
        
        try:
            # –û–¥–æ–±—Ä—è–µ–º –∑–∞—è–≤–∫—É
            await context.bot.approve_chat_join_request(
                chat_id=int(chat_id),
                user_id=int(user_id)
            )
            
            # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–ø–∏—Å–æ–∫ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö
            self.approved_users.add(user_id)
            
            # –£–¥–∞–ª—è–µ–º –∏–∑ –æ–∂–∏–¥–∞—é—â–∏—Ö
            user_data = self.pending_requests.pop(user_id)
            
            logger.info(f"–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–¥–æ–±—Ä–µ–Ω–∞ –∑–∞—è–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_data['user_data']['first_name']} ({user_id})")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
            self.update_channel_stats(chat_id, 'total_approved')
            

            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏: {e}")
            # –£–¥–∞–ª—è–µ–º –∏–∑ –æ–∂–∏–¥–∞—é—â–∏—Ö –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            self.pending_requests.pop(user_id, None)
    
    async def handle_chat_member_update(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        if not update.chat_member:
            return
        
        chat_member_update = update.chat_member
        user_id = str(chat_member_update.new_chat_member.user.id)
        old_status = chat_member_update.old_chat_member.status
        new_status = chat_member_update.new_chat_member.status
        chat_type = update.effective_chat.type
        chat_id = str(update.effective_chat.id)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç –≤ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
        self.tracked_groups.add(chat_id)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–ª —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –≥—Ä—É–ø–ø—ã
        if (old_status in [ChatMember.LEFT, ChatMember.KICKED] and 
            new_status in [ChatMember.MEMBER, ChatMember.ADMINISTRATOR, ChatMember.OWNER]):
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∫–æ—Ç–æ—Ä–æ–≥–æ –º—ã –æ–¥–æ–±—Ä–∏–ª–∏
            if user_id in self.approved_users:
                await self.send_welcome_message(update, context, chat_member_update.new_chat_member.user)
                self.approved_users.remove(user_id)  # –£–¥–∞–ª—è–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        
        # –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ª—é–¥–µ–π, –ø–æ–∫–∏–¥–∞—é—â–∏—Ö –≥—Ä—É–ø–ø—É
        elif (old_status in [ChatMember.MEMBER, ChatMember.ADMINISTRATOR] and 
              new_status in [ChatMember.LEFT, ChatMember.KICKED]):
            
            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–∫–∏–Ω—É–≤—à–∏—Ö –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
            chat_title = update.effective_chat.title or f"–ß–∞—Ç {chat_id}"
            self.get_or_create_channel_stats(chat_id, chat_title)
            self.update_channel_stats(chat_id, 'hourly_left')
            self.update_channel_stats(chat_id, 'daily_left')
            self.update_channel_stats(chat_id, 'total_left')
            
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {chat_member_update.new_chat_member.user.first_name} ({user_id}) –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç '{chat_title}' ({chat_type})")
    
    async def send_welcome_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE, user):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–æ–≤–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É"""
        chat_id = update.effective_chat.id
        chat_type = update.effective_chat.type
        welcome_text = self.config.get("welcome_message", "üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à—É –≥—Ä—É–ø–ø—É!")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –±–æ—Ç–∞ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
        try:
            bot_member = await context.bot.get_chat_member(chat_id, context.bot.id)
            if not bot_member.can_send_messages:
                logger.warning(f"–ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç {chat_id}")
                return
        except (BadRequest, Forbidden) as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –±–æ—Ç–∞ –≤ —á–∞—Ç–µ {chat_id}: {e}")
            return
        
        # –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if chat_type == ChatType.CHANNEL:
            # –î–ª—è –∫–∞–Ω–∞–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
            personalized_message = f"üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}! {welcome_text}"
        else:
            # –î–ª—è –≥—Ä—É–ø–ø –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ
            user_mention = f"[{user.first_name}](tg://user?id={user.id})"
            personalized_message = f"{user_mention}, {welcome_text}"
        
        try:
            await context.bot.send_message(
                chat_id=chat_id,
                text=personalized_message,
                parse_mode=ParseMode.MARKDOWN
            )
            logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.first_name} ({user.id}) –≤ {chat_type}")
        except (BadRequest, Forbidden) as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            # –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            try:
                simple_message = f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}! {welcome_text}"
                await context.bot.send_message(chat_id=chat_id, text=simple_message)
                logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ")
            except Exception as e2:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–∂–µ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {e2}")
    
    async def notify_admins(self, context: ContextTypes.DEFAULT_TYPE, request):
        """–£–≤–µ–¥–æ–º–ª—è–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –æ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–µ"""
        try:
            # –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
            username = request.from_user.username if request.from_user.username else '–Ω–µ —É–∫–∞–∑–∞–Ω'
            last_name = ' ' + request.from_user.last_name if request.from_user.last_name else ''
            delay_minutes = self.config.get('auto_approve_delay', 600) // 60
            
            admin_message = (
                f"üìù –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ:\n"
                f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {request.from_user.first_name}{last_name}\n"
                f"üÜî ID: {request.from_user.id}\n"
                f"üë§ Username: {username}\n"
                f"‚è∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ {delay_minutes} –º–∏–Ω—É—Ç"
            )
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
            chat_admins = await context.bot.get_chat_administrators(request.chat.id)
            
            for admin in chat_admins:
                if not admin.user.is_bot:  # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–æ—Ç–∞–º
                    try:
                        await context.bot.send_message(
                            chat_id=admin.user.id,
                            text=admin_message
                        )
                    except Exception as e:
                        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É {admin.user.id}: {e}")
                        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: {e}")
    
    def get_or_create_channel_stats(self, chat_id: str, chat_title: str):
        """–°–æ–∑–¥–∞–µ—Ç –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –∫–∞–Ω–∞–ª–∞"""
        if chat_id not in self.channel_stats:
            self.channel_stats[chat_id] = {
                'title': chat_title,
                'hourly_requests': 0,
                'hourly_left': 0,
                'daily_requests': 0,
                'daily_left': 0,
                'total_requests': 0,
                'total_approved': 0,
                'total_left': 0,
                'last_activity': datetime.now()
            }
            logger.info(f"–°–æ–∑–¥–∞–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∫–∞–Ω–∞–ª–∞ '{chat_title}' ({chat_id})")
        return self.channel_stats[chat_id]
    
    def update_channel_stats(self, chat_id: str, stat_type: str):
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–Ω–∞–ª–∞"""
        if chat_id in self.channel_stats:
            self.channel_stats[chat_id][stat_type] += 1
            self.channel_stats[chat_id]['last_activity'] = datetime.now()
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            if stat_type in self.global_stats:
                self.global_stats[stat_type] += 1



    async def send_hourly_stats(self, context: ContextTypes.DEFAULT_TYPE):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—á–∞—Å–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º"""
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        total_requests = sum(stats['hourly_requests'] for stats in self.channel_stats.values())
        total_left = sum(stats['hourly_left'] for stats in self.channel_stats.values())
        
        if total_requests == 0 and total_left == 0:
            return  # –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        
        current_time = datetime.now().strftime("%H:%M")
        
        # –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        global_message = (
            f"üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —á–∞—Å ({current_time}):\n"
            f"üìà –ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫: {total_requests}\n"
            f"üìâ –ü–æ–∫–∏–Ω—É–ª–∏: {total_left}\n"
            f"üîÑ –ß–∏—Å—Ç—ã–π –ø—Ä–∏—Ä–æ—Å—Ç: {total_requests - total_left}\n\n"
        )
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–Ω–∞–ª–∞–º
        channel_details = []
        for chat_id, stats in self.channel_stats.items():
            if stats['hourly_requests'] > 0 or stats['hourly_left'] > 0:
                channel_growth = stats['hourly_requests'] - stats['hourly_left']
                growth_emoji = "üìà" if channel_growth > 0 else "üìâ" if channel_growth < 0 else "‚ûñ"
                
                channel_details.append(
                    f"üè∑Ô∏è {stats['title'][:30]}:\n"
                    f"  ÔøΩ –ó–∞—è–≤–æ–∫: {stats['hourly_requests']}\n"
                    f"  üëã –ü–æ–∫–∏–Ω—É–ª–∏: {stats['hourly_left']}\n"
                    f"  {growth_emoji} –ü—Ä–∏—Ä–æ—Å—Ç: {channel_growth}"
                )
        
        if channel_details:
            stats_message = global_message + "üìã –ü–æ –∫–∞–Ω–∞–ª–∞–º:\n" + "\n\n".join(channel_details)
        else:
            stats_message = global_message.rstrip()
        
        await self.send_stats_to_admins(context, stats_message)
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—á–∞—Å–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        for stats in self.channel_stats.values():
            stats['hourly_requests'] = 0
            stats['hourly_left'] = 0
        self.global_stats['hourly_requests'] = 0
        self.global_stats['hourly_left'] = 0
    
    async def send_daily_stats(self, context: ContextTypes.DEFAULT_TYPE):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ 8 —á–∞—Å–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º"""
        current_time = datetime.now().strftime("%d.%m.%Y %H:%M")
        
        # –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 8 —á–∞—Å–æ–≤
        total_daily_requests = sum(stats['daily_requests'] for stats in self.channel_stats.values())
        total_daily_left = sum(stats['daily_left'] for stats in self.channel_stats.values())
        total_approved = sum(stats['total_approved'] for stats in self.channel_stats.values())
        total_requests = sum(stats['total_requests'] for stats in self.channel_stats.values())
        total_left = sum(stats['total_left'] for stats in self.channel_stats.values())
        
        global_message = (
            f"üìà –û–±—â–∏–π –æ—Ç—á–µ—Ç –∑–∞ 8 —á–∞—Å–æ–≤ ({current_time}):\n\n"
            f"üìù –ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫: {total_daily_requests}\n"
            f"‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ: {total_approved}\n"
            f"üëã –ü–æ–∫–∏–Ω—É–ª–∏: {total_daily_left}\n"
            f"üîÑ –ß–∏—Å—Ç—ã–π –ø—Ä–∏—Ä–æ—Å—Ç: {total_daily_requests - total_daily_left}\n\n"
            f"üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å –∑–∞–ø—É—Å–∫–∞:\n"
            f"üìã –í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫: {total_requests}\n"
            f"‚úÖ –í—Å–µ–≥–æ –æ–¥–æ–±—Ä–µ–Ω–æ: {total_approved}\n"
            f"üëã –í—Å–µ–≥–æ –ø–æ–∫–∏–Ω—É–ª–æ: {total_left}\n\n"
        )
        
        # –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–Ω–∞–ª–∞–º
        channel_details = []
        for chat_id, stats in self.channel_stats.items():
            if stats['total_requests'] > 0 or stats['total_left'] > 0:
                daily_growth = stats['daily_requests'] - stats['daily_left']
                total_growth = stats['total_requests'] - stats['total_left']
                
                daily_emoji = "üìà" if daily_growth > 0 else "üìâ" if daily_growth < 0 else "‚ûñ"
                total_emoji = "üìà" if total_growth > 0 else "üìâ" if total_growth < 0 else "‚ûñ"
                
                channel_details.append(
                    f"üè∑Ô∏è {stats['title'][:35]}:\n"
                    f"  ÔøΩ –ó–∞ 8 —á–∞—Å–æ–≤: {stats['daily_requests']} –∑–∞—è–≤–æ–∫, {stats['daily_left']} –ø–æ–∫–∏–Ω—É–ª–∏\n"
                    f"  {daily_emoji} –ü—Ä–∏—Ä–æ—Å—Ç –∑–∞ 8—á: {daily_growth}\n"
                    f"  üìä –í—Å–µ–≥–æ: {stats['total_requests']} –∑–∞—è–≤–æ–∫, {stats['total_approved']} –æ–¥–æ–±—Ä–µ–Ω–æ\n"
                    f"  {total_emoji} –û–±—â–∏–π –ø—Ä–∏—Ä–æ—Å—Ç: {total_growth}"
                )
        
        if channel_details:
            stats_message = global_message + "üìã –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–∞–Ω–∞–ª–∞–º:\n\n" + "\n\n".join(channel_details)
        else:
            stats_message = global_message.rstrip()
        
        await self.send_stats_to_admins(context, stats_message)
        
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–Ω–µ–≤–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        for stats in self.channel_stats.values():
            stats['daily_requests'] = 0
            stats['daily_left'] = 0
        self.global_stats['daily_requests'] = 0
        self.global_stats['daily_left'] = 0
    
    async def send_stats_to_admins(self, context: ContextTypes.DEFAULT_TYPE, message: str):
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –≤—Å–µ—Ö –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –≥—Ä—É–ø–ø"""
        sent_to_admins = set()  # –ß—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥—É–±–ª–∏ –æ–¥–Ω–æ–º—É –∞–¥–º–∏–Ω—É
        
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ –≥—Ä—É–ø–ø—ã
        if not self.tracked_groups:
            logger.warning("–ù–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö –≥—Ä—É–ø–ø –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
            return
        
        for chat_id in list(self.tracked_groups):  # –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
            try:
                # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∞—Ç–µ
                chat = await context.bot.get_chat(int(chat_id))
                chat_type = chat.type
                
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–∞–Ω–∞–ª—ã, –µ—Å–ª–∏ –±–æ—Ç –Ω–µ –∞–¥–º–∏–Ω
                if chat_type == ChatType.CHANNEL:
                    try:
                        bot_member = await context.bot.get_chat_member(int(chat_id), context.bot.id)
                        if bot_member.status not in [ChatMember.ADMINISTRATOR, ChatMember.OWNER]:
                            continue
                    except (BadRequest, Forbidden):
                        continue
                
                chat_admins = await context.bot.get_chat_administrators(int(chat_id))
                
                for admin in chat_admins:
                    if not admin.user.is_bot and admin.user.id not in sent_to_admins:
                        try:
                            await context.bot.send_message(
                                chat_id=admin.user.id,
                                text=message
                            )
                            sent_to_admins.add(admin.user.id)
                            logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–¥–º–∏–Ω—É {admin.user.id} –∏–∑ {chat_type}")
                        except (BadRequest, Forbidden) as e:
                            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∞–¥–º–∏–Ω—É {admin.user.id}: {e}")
                        except Exception as e:
                            logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞–¥–º–∏–Ω—É {admin.user.id}: {e}")
                            
            except (BadRequest, Forbidden) as e:
                logger.warning(f"–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É {chat_id}: {e}")
                # –£–¥–∞–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π —á–∞—Ç –∏–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö
                self.tracked_groups.discard(chat_id)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–æ–≤ –¥–ª—è —á–∞—Ç–∞ {chat_id}: {e}")
    
    def save_stats_to_file(self):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —Ñ–∞–π–ª"""
        try:
            stats_data = {
                'channel_stats': {},
                'global_stats': self.global_stats,
                'tracked_groups': list(self.tracked_groups),
                'last_saved': datetime.now().isoformat()
            }
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º datetime –≤ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è JSON
            for chat_id, stats in self.channel_stats.items():
                stats_copy = stats.copy()
                if 'last_activity' in stats_copy:
                    stats_copy['last_activity'] = stats_copy['last_activity'].isoformat()
                stats_data['channel_stats'][chat_id] = stats_copy
            
            with open('bot_stats.json', 'w', encoding='utf-8') as f:
                json.dump(stats_data, f, ensure_ascii=False, indent=2)
            
            logger.info("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ —Ñ–∞–π–ª")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
    
    def load_stats_from_file(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ —Ñ–∞–π–ª–∞"""
        try:
            with open('bot_stats.json', 'r', encoding='utf-8') as f:
                stats_data = json.load(f)
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            self.global_stats = stats_data.get('global_stats', self.global_stats)
            self.tracked_groups = set(stats_data.get('tracked_groups', []))
            
            # –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–Ω–∞–ª–æ–≤
            for chat_id, stats in stats_data.get('channel_stats', {}).items():
                if 'last_activity' in stats and isinstance(stats['last_activity'], str):
                    try:
                        stats['last_activity'] = datetime.fromisoformat(stats['last_activity'])
                    except:
                        stats['last_activity'] = datetime.now()
                self.channel_stats[chat_id] = stats
            
            logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è {len(self.channel_stats)} –∫–∞–Ω–∞–ª–æ–≤")
        except FileNotFoundError:
            logger.info("–§–∞–π–ª —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø—É—Å—Ç–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
    
    async def periodic_save_stats(self, context: ContextTypes.DEFAULT_TYPE):
        """–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
        self.save_stats_to_file()

    async def setup_periodic_tasks(self, context: ContextTypes.DEFAULT_TYPE):
        """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        if context.job_queue is not None:
            # –ü–æ—á–∞—Å–æ–≤—ã–µ –æ—Ç—á–µ—Ç—ã
            context.job_queue.run_repeating(
                self.send_hourly_stats,
                interval=3600,  # –∫–∞–∂–¥—ã–π —á–∞—Å (3600 —Å–µ–∫—É–Ω–¥)
                first=3600,     # –ø–µ—Ä–≤—ã–π –æ—Ç—á–µ—Ç —á–µ—Ä–µ–∑ —á–∞—Å
                name="hourly_stats"
            )
            
            # –û—Ç—á–µ—Ç—ã –∫–∞–∂–¥—ã–µ 8 —á–∞—Å–æ–≤
            context.job_queue.run_repeating(
                self.send_daily_stats,
                interval=28800,  # –∫–∞–∂–¥—ã–µ 8 —á–∞—Å–æ–≤ (8 * 3600 —Å–µ–∫—É–Ω–¥)
                first=28800,     # –ø–µ—Ä–≤—ã–π –æ—Ç—á–µ—Ç —á–µ—Ä–µ–∑ 8 —á–∞—Å–æ–≤
                name="daily_stats"
            )
            
            # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            context.job_queue.run_repeating(
                self.periodic_save_stats,
                interval=3600,  # –∫–∞–∂–¥—ã–µ 60 –º–∏–Ω—É—Ç
                first=3600,     # –ø–µ—Ä–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 60 –º–∏–Ω—É—Ç
                name="save_stats"
            )
            
            logger.info("–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
        else:
            logger.error("JobQueue –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á!")

    async def handle_stats_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /stats –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        if not update.message:
            return
            
        user_id = update.effective_user.id
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
        is_admin = False
        for chat_id in self.tracked_groups:
            try:
                chat_admins = await context.bot.get_chat_administrators(int(chat_id))
                if any(admin.user.id == user_id and not admin.user.is_bot for admin in chat_admins):
                    is_admin = True
                    break
            except Exception:
                continue
        
        if not is_admin:
            await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
        current_time = datetime.now().strftime("%d.%m.%Y %H:%M")
        
        if not self.channel_stats:
            await update.message.reply_text("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—É—Å—Ç–∞ - –±–æ—Ç –µ—â–µ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª –∑–∞—è–≤–∫–∏")
            return
        
        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        total_requests = sum(stats['total_requests'] for stats in self.channel_stats.values())
        total_approved = sum(stats['total_approved'] for stats in self.channel_stats.values())
        total_left = sum(stats['total_left'] for stats in self.channel_stats.values())
        
        message = (
            f"üìä –¢–µ–∫—É—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ({current_time}):\n\n"
            f"üåê –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:\n"
            f"üìã –í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫: {total_requests}\n"
            f"‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ: {total_approved}\n"
            f"üëã –ü–æ–∫–∏–Ω—É–ª–∏: {total_left}\n"
            f"üîÑ –û–±—â–∏–π –ø—Ä–∏—Ä–æ—Å—Ç: {total_requests - total_left}\n\n"
        )
        
        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞–Ω–∞–ª–∞–º
        active_channels = [(chat_id, stats) for chat_id, stats in self.channel_stats.items() 
                          if stats['total_requests'] > 0 or stats['total_left'] > 0]
        
        if active_channels:
            message += "üìã –ü–û –ö–ê–ù–ê–õ–ê–ú:\n"
            for i, (chat_id, stats) in enumerate(active_channels, 1):
                growth = stats['total_requests'] - stats['total_left']
                growth_emoji = "üìà" if growth > 0 else "üìâ" if growth < 0 else "‚ûñ"
                
                message += (
                    f"\n{i}. üè∑Ô∏è {stats['title'][:30]}:\n"
                    f"   üì• –ó–∞—è–≤–æ–∫: {stats['total_requests']}\n"
                    f"   ‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ: {stats['total_approved']}\n"
                    f"   üëã –ü–æ–∫–∏–Ω—É–ª–∏: {stats['total_left']}\n"
                    f"   {growth_emoji} –ü—Ä–∏—Ä–æ—Å—Ç: {growth}\n"
                )
        
        try:
            await update.message.reply_text(message)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")

    def run(self):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞"""
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å JobQueue
        from telegram.ext import JobQueue
        
        application = (
            Application.builder()
            .token(self.token)
            .job_queue(JobQueue())
            .build()
        )
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        application.add_handler(CommandHandler("stats", self.handle_stats_command))
        application.add_handler(ChatJoinRequestHandler(self.handle_chat_join_request))
        application.add_handler(ChatMemberHandler(self.handle_chat_member_update))
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        application.job_queue.run_once(
            self.setup_periodic_tasks,
            0  # –ó–∞–ø—É—Å–∫–∞–µ–º —Å—Ä–∞–∑—É
        )
        
        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º graceful shutdown
        def signal_handler(signum, frame):
            logger.info("–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...")
            self.save_stats_to_file()
            logger.info("–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞...")
            application.stop()
            sys.exit(0)
        
        signal.signal(signal.SIGINT, signal_handler)
        signal.signal(signal.SIGTERM, signal_handler)
        
        logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        logger.info(f"–û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
        is_production = os.getenv('RENDER') == 'true' or os.getenv('PRODUCTION') == 'true'
        
        if is_production:
            # –í production –∏—Å–ø–æ–ª—å–∑—É–µ–º webhook
            self.run_webhook(application)
        else:
            # –í development –∏—Å–ø–æ–ª—å–∑—É–µ–º polling
            self.run_polling(application)
    
    def run_webhook(self, application):
        """–ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ webhook (–¥–ª—è production)"""
        webhook_url = os.getenv('WEBHOOK_URL')
        port = int(os.getenv('PORT', 8000))
        
        if not webhook_url:
            logger.error("‚ùå WEBHOOK_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è production —Ä–µ–∂–∏–º–∞!")
            logger.error("üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é WEBHOOK_URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Render")
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π URL –¥–ª—è webhook
        webhook_path = f"/{self.token}"
        full_webhook_url = f"{webhook_url.rstrip('/')}{webhook_path}"
        
        logger.info(f"üåê –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ webhook —Ä–µ–∂–∏–º–µ")
        logger.info(f"üîó Webhook URL: {full_webhook_url}")
        logger.info(f"üîå Port: {port}")
        
        try:
            application.run_webhook(
                listen="0.0.0.0",
                port=port,
                url_path=webhook_path,
                webhook_url=full_webhook_url,
                allowed_updates=Update.ALL_TYPES,
                drop_pending_updates=True
            )
        except Exception as e:
            logger.error(f"üí• –û—à–∏–±–∫–∞ webhook: {e}")
            raise
    
    def run_polling(self, application):
        """–ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ polling (–¥–ª—è development)"""
        logger.info("üîÑ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ polling —Ä–µ–∂–∏–º–µ (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)")
        
        max_retries = 3
        retry_count = 0
        
        while retry_count < max_retries:
            try:
                application.run_polling(
                    allowed_updates=Update.ALL_TYPES,
                    drop_pending_updates=True  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
                )
                break  # –ï—Å–ª–∏ polling –∑–∞–ø—É—Å—Ç–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
                
            except Conflict as e:
                retry_count += 1
                logger.error(f"‚ö†Ô∏è –ö–æ–Ω—Ñ–ª–∏–∫—Ç polling (–ø–æ–ø—ã—Ç–∫–∞ {retry_count}/{max_retries}): {e}")
                
                if retry_count < max_retries:
                    logger.info(f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ {retry_count * 5} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π...")
                    asyncio.run(asyncio.sleep(retry_count * 5))
                else:
                    logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å polling –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫!")
                    logger.error("üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
                    logger.error("   - –ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ (–ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –Ω–∞ Render)")
                    logger.error("   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ webhook –¥–ª—è production –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥—Ä—É–≥–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä—ã")
                    raise
                    
            except (TimedOut, NetworkError) as e:
                retry_count += 1
                logger.error(f"üåê –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ (–ø–æ–ø—ã—Ç–∫–∞ {retry_count}/{max_retries}): {e}")
                
                if retry_count < max_retries:
                    logger.info(f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ {retry_count * 3} —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π...")
                    asyncio.run(asyncio.sleep(retry_count * 3))
                else:
                    logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫!")
                    raise
                    
            except Exception as e:
                logger.error(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")
                raise

def main():
    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ —Ñ–∞–π–ª–∞
    token = os.getenv('TELEGRAM_BOT_TOKEN')
    
    if not token:
        try:
            # –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ .env —Ñ–∞–π–ª–∞ (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
            with open('.env', 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if line.startswith('TELEGRAM_BOT_TOKEN=') and not line.startswith('#'):
                        token = line.split('=', 1)[1].strip()
                        # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                        if token.startswith('"') and token.endswith('"'):
                            token = token[1:-1]
                        if token.startswith("'") and token.endswith("'"):
                            token = token[1:-1]
                        break
        except FileNotFoundError:
            logger.warning("–§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è")
    
    if not token or token == 'your_bot_token_here':
        logger.error(
            "‚ùå TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω!\n"
            "–î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å —Ç–æ–∫–µ–Ω–æ–º\n"
            "–î–ª—è Render: –¥–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN"
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å : –∏ –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω—ã–º)
    if ':' not in token or len(token) < 35:
        logger.error("‚ùå –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–º–µ–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!")
        return
    
    logger.info(f"üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ —Å —Ç–æ–∫–µ–Ω–æ–º: {token[:10]}...")
    logger.info(f"üåç –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: {'PRODUCTION (Render)' if os.getenv('RENDER') else 'DEVELOPMENT (Local)'}")
    
    try:
        bot = TelegramBot(token)
        bot.run()
    except KeyboardInterrupt:
        logger.info("üëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        logger.error(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        raise

if __name__ == '__main__':
    main()
